platform: linux
image_resource:
  type: registry-image
  source:
    repository: dtzar/helm-kubectl
    tag: 3.3.1
inputs:
  - name: repository
run:
  path: bash
  args:
    - -c
    - |
      set -e

      echo Linting...
      helm lint ((chart-path))

      # setup auth for kubectl command
      # required for --dry-run=client with kubectl <=1.18
      mkdir -p /run/secrets/kubernetes.io/serviceaccount
      echo "((namespace))" > /run/secrets/kubernetes.io/serviceaccount/namespace
      echo "((certificate_authority_data))" > /run/secrets/kubernetes.io/serviceaccount/ca.crt
      echo "((token))" > /run/secrets/kubernetes.io/serviceaccount/token

      echo Validating resources with default values...
      helm template release-name ((chart-path)) \
        | kubectl apply -f - --dry-run=client

      echo 'Success!'
