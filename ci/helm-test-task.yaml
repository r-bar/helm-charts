platform: linux
image_resource:
  type: registry-image
  source:
    repository: dtzar/helm-kubectl
    tag: 3.3.1
inputs:
  - name: repository
run:
  path: bash
  args:
    - -c
    - |
      set -e

      echo Linting...
      helm lint ((chart-path))

      # setup auth for kubectl command
      # required for --dry-run=client with kubectl <=1.18
      echo "((certificate-authority-data))" > /tmp/ca.crt
      echo "((token))" > /tmp/token
      kubectl config set-cluster default --server ((cluster-url))
      kubectl config set-credentails admin \
        --client-certificate /tmp/ca.crt --client-key /tmp/token
      kubectl config set-context default --cluster default --user admin --namespace ((namespace))
      kubectl config use-context default

      echo Validating resources with default values...
      helm template release-name ((chart-path)) \
        | kubectl apply -f - --dry-run=client

      echo 'Success!'
